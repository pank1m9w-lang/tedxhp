---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import BottomNav from '../components/BottomNav.astro';
import Footer from '../components/Footer.astro';
---

<BaseLayout title="オーディエンス参加申込 - TEDx Tsushima Youth 2025">
  <Header />

  <main>
    <section class="page-hero">
      <div class="container">
        <h1 class="page-title">オーディエンス参加申込</h1>
        <p class="page-subtitle">TEDx Tsushima Youth 2025 会場参加フォーム</p>
      </div>
    </section>

    <section class="registration-form">
      <form id="audience-form">
        <!-- 代表者情報 -->
        <div class="form-section">
          <h3>代表者情報</h3>
          <div class="form-group">
            <label for="rep-name">代表者氏名 <span class="required">*</span></label>
            <input type="text" id="rep-name" name="rep_name" required placeholder="山田 太郎">
          </div>
          <div class="form-group">
            <label for="rep-email">メールアドレス <span class="required">*</span></label>
            <input type="email" id="rep-email" name="rep_email" required placeholder="example@email.com">
          </div>
          <div class="form-group">
            <label for="rep-phone">電話番号 <span class="required">*</span></label>
            <input type="tel" id="rep-phone" name="rep_phone" required placeholder="090-1234-5678">
          </div>
        </div>

        <!-- 参加メンバー -->
        <div class="form-section">
          <h3>参加メンバー</h3>
          <p class="form-note">代表者以外に参加される方がいる場合は、下記から追加してください。</p>

          <div id="members-container">
            <!-- 動的に追加されるメンバー -->
          </div>

          <button type="button" class="add-member-btn" id="add-member-btn">+ メンバーを追加</button>
        </div>

        <!-- 写真撮影 -->
        <div class="form-section">
          <h3>写真撮影について</h3>
          <div class="form-group">
            <label>イベント中の写真撮影・SNS等への掲載について <span class="required">*</span></label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="photo_permission" value="ok" required>
                撮影・掲載OK
              </label>
              <label class="radio-option">
                <input type="radio" name="photo_permission" value="no-face">
                顔が映らなければOK
              </label>
              <label class="radio-option">
                <input type="radio" name="photo_permission" value="ng">
                撮影・掲載NG
              </label>
            </div>
          </div>
        </div>

        <!-- アフターパーティ -->
        <div class="form-section">
          <h3>アフターパーティ</h3>
          <div class="form-group">
            <label>アフターパーティへの参加 <span class="required">*</span></label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="after_party" value="yes" required id="party-yes">
                参加する
              </label>
              <label class="radio-option">
                <input type="radio" name="after_party" value="no" id="party-no">
                参加しない
              </label>
            </div>
            <div class="party-info">
              <strong>参加費：1人 5,000円</strong><br>
              イベント終了後、スピーカーや参加者との交流会を予定しています。
            </div>
          </div>

          <div id="party-attendees" style="display: none;">
            <div class="form-group">
              <label for="party-count">アフターパーティ参加人数</label>
              <select id="party-count" name="party_count">
                <option value="1">1人（代表者のみ）</option>
              </select>
            </div>
            <div class="total-display">
              <p>アフターパーティ参加費合計</p>
              <p class="amount" id="party-total">¥5,000</p>
            </div>
          </div>
        </div>

        <!-- 送信ボタン -->
        <button type="submit" class="submit-btn">申込を送信する</button>
      </form>

      <div id="form-message" class="form-message" style="display: none;"></div>
    </section>
  </main>

  <Footer />
  <BottomNav />
</BaseLayout>

<style>
  .registration-form {
    max-width: 700px;
    margin: 0 auto;
    padding: 2rem;
  }
  .form-section {
    background: #fff;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  .form-section h3 {
    color: #e62b1e;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
  }
  .form-group {
    margin-bottom: 1.5rem;
  }
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #e62b1e;
  }
  .required {
    color: #e62b1e;
  }
  .member-entry {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    position: relative;
  }
  .member-entry h4 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    color: #666;
  }
  .remove-member {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
  }
  .add-member-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    margin-top: 1rem;
  }
  .add-member-btn:hover {
    background: #218838;
  }
  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .radio-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }
  .radio-option input {
    width: auto;
  }
  .party-info {
    background: #fff3cd;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    font-size: 0.9rem;
  }
  .party-info strong {
    color: #856404;
  }
  .submit-btn {
    background: #e62b1e;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    width: 100%;
    font-weight: 600;
  }
  .submit-btn:hover {
    background: #c92419;
  }
  .form-note {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.5rem;
  }
  .total-display {
    background: #e8f5e9;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    text-align: center;
  }
  .total-display .amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2e7d32;
  }
  #members-container {
    margin-bottom: 1rem;
  }
  .submit-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .form-message {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
  }
  .form-message.success {
    background: #d4edda;
    color: #155724;
  }
  .form-message.error {
    background: #f8d7da;
    color: #721c24;
  }
</style>

<script>
  let memberCount = 0;

  function addMember() {
    memberCount++;
    const container = document.getElementById('members-container');
    const memberDiv = document.createElement('div');
    memberDiv.className = 'member-entry';
    memberDiv.id = `member-${memberCount}`;
    memberDiv.innerHTML = `
      <h4>追加メンバー ${memberCount}</h4>
      <button type="button" class="remove-member" data-member-id="${memberCount}">×</button>
      <div class="form-group">
        <label for="member-name-${memberCount}">氏名 <span class="required">*</span></label>
        <input type="text" id="member-name-${memberCount}" name="member_name_${memberCount}" required placeholder="氏名">
      </div>
    `;
    container?.appendChild(memberDiv);

    // Add remove event listener
    memberDiv.querySelector('.remove-member')?.addEventListener('click', (e) => {
      const id = (e.target as HTMLElement).dataset.memberId;
      document.getElementById(`member-${id}`)?.remove();
      updatePartyOptions();
    });

    updatePartyOptions();
  }

  function updatePartyOptions() {
    const container = document.getElementById('members-container');
    const memberEntries = container?.querySelectorAll('.member-entry') || [];
    const totalPeople = memberEntries.length + 1; // +1 for representative

    const select = document.getElementById('party-count') as HTMLSelectElement;
    if (!select) return;

    select.innerHTML = '';

    for (let i = 1; i <= totalPeople; i++) {
      const option = document.createElement('option');
      option.value = String(i);
      if (i === 1) {
        option.textContent = `1人（代表者のみ）`;
      } else {
        option.textContent = `${i}人`;
      }
      select.appendChild(option);
    }

    // Default to all members
    select.value = String(totalPeople);
    updateTotal();
  }

  function updateTotal() {
    const partyYes = document.getElementById('party-yes') as HTMLInputElement;
    const partyAttendeesDiv = document.getElementById('party-attendees');
    const partyTotal = document.getElementById('party-total');
    const partyCount = document.getElementById('party-count') as HTMLSelectElement;

    if (partyYes?.checked) {
      if (partyAttendeesDiv) partyAttendeesDiv.style.display = 'block';
      const count = parseInt(partyCount?.value || '1');
      const total = count * 5000;
      if (partyTotal) partyTotal.textContent = `¥${total.toLocaleString()}`;
    } else {
      if (partyAttendeesDiv) partyAttendeesDiv.style.display = 'none';
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    // Add member button
    document.getElementById('add-member-btn')?.addEventListener('click', addMember);

    // Party radio buttons
    document.getElementById('party-yes')?.addEventListener('change', updateTotal);
    document.getElementById('party-no')?.addEventListener('change', updateTotal);
    document.getElementById('party-count')?.addEventListener('change', updateTotal);

    // Form submission
    const form = document.getElementById('audience-form') as HTMLFormElement;
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = form.querySelector('.submit-btn') as HTMLButtonElement;
      const messageDiv = document.getElementById('form-message');

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '送信中...';
      }

      // Collect form data
      const formData = new FormData(form);
      const data: Record<string, string | number> = {};
      formData.forEach((value, key) => {
        data[key] = String(value);
      });

      // Collect member names
      const members: string[] = [];
      document.querySelectorAll('#members-container .member-entry input').forEach((input) => {
        members.push((input as HTMLInputElement).value);
      });
      data['members'] = members.join(', ');
      data['party_count'] = parseInt(String(data['party_count'])) || 0;

      try {
        const response = await fetch('/api/audience', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          if (messageDiv) {
            messageDiv.className = 'form-message success';
            messageDiv.textContent = 'お申し込みありがとうございます。';
            messageDiv.style.display = 'block';
          }
          form.reset();
          document.getElementById('members-container')!.innerHTML = '';
          memberCount = 0;
          updatePartyOptions();
        } else {
          throw new Error('送信失敗');
        }
      } catch (error) {
        if (messageDiv) {
          messageDiv.className = 'form-message error';
          messageDiv.textContent = '送信に失敗しました。時間をおいて再度お試しください。';
          messageDiv.style.display = 'block';
        }
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = '申込を送信する';
        }
      }
    });

    updatePartyOptions();
  });
</script>
